<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kasbon Kantin Asbaja</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    html {
      height: 100%;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    .toast.success {
      background-color: #10b981;
    }

    .toast.error {
      background-color: #ef4444;
    }

    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      animation: slideIn 0.3s ease-out;
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: box-shadow 0.2s;
    }

    .card:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .loading-spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #3b82f6;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-left: 8px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div id="app" class="min-h-full" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><!-- Header -->
   <header class="text-white p-6 shadow-lg">
    <div class="max-w-7xl mx-auto">
     <h1 id="appTitle" class="text-4xl font-bold mb-2">Kasbon Kantin Asbaja</h1>
     <p id="kantinName" class="text-xl opacity-90">Kantin Asbaja</p>
    </div>
   </header><!-- Main Content -->
   <main class="max-w-7xl mx-auto p-6"><!-- Navigation Tabs -->
    <div class="bg-white rounded-lg shadow-lg mb-6 p-2">
     <div class="flex flex-wrap gap-2"><button onclick="showTab('customers')" id="tabCustomers" class="btn flex-1 min-w-[120px]" style="background-color: #667eea; color: white;"> üë• Pelanggan </button> <button onclick="showTab('kasbon')" id="tabKasbon" class="btn flex-1 min-w-[120px]" style="background-color: #e5e7eb; color: #374151;"> üí∞ Kasbon </button> <button onclick="showTab('payment')" id="tabPayment" class="btn flex-1 min-w-[120px]" style="background-color: #e5e7eb; color: #374151;"> üí≥ Pembayaran </button>
     </div>
    </div><!-- Customers Tab -->
    <div id="customersTab" class="tab-content hidden">
     <div class="card mb-6">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-2xl font-bold" style="color: #667eea;">Daftar Pelanggan</h3><button onclick="showAddCustomerModal()" class="btn" style="background-color: #667eea; color: white;"> ‚ûï Tambah Pelanggan </button>
      </div>
      <div id="customersList" class="space-y-3"></div>
     </div>
    </div><!-- Kasbon Tab -->
    <div id="kasbonTab" class="tab-content hidden">
     <div class="card mb-6">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-2xl font-bold" style="color: #667eea;">Tambah Kasbon</h3>
      </div>
      <form id="kasbonForm" class="space-y-4">
       <div><label for="kasbonCustomer" class="block text-sm font-medium text-gray-700 mb-1">Pilih Pelanggan</label> <select id="kasbonCustomer" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"> <option value="">-- Pilih Pelanggan --</option> </select>
       </div>
       <div><label for="kasbonDate" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Kasbon</label> <input type="date" id="kasbonDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
       </div>
       <div><label for="kasbonAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Kasbon (Rp)</label> <input type="number" id="kasbonAmount" required min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan jumlah">
       </div>
       <div><label for="kasbonDescription" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label> <textarea id="kasbonDescription" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Keterangan kasbon (opsional)"></textarea>
       </div><button type="submit" class="btn w-full" style="background-color: #667eea; color: white;"> üí∞ Simpan Kasbon </button>
      </form>
     </div>
     <div class="card">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-2xl font-bold" style="color: #667eea;">Riwayat Kasbon</h3><button onclick="printKasbonPDF()" class="btn" style="background-color: #10b981; color: white;"> üñ®Ô∏è Cetak PDF </button>
      </div><!-- Filter Section -->
      <div class="mb-6 p-4 rounded-lg" style="background-color: #f9fafb; border: 2px solid #e5e7eb;">
       <h4 class="font-semibold mb-3 flex items-center gap-2" style="color: #667eea;">üîç Filter Riwayat Kasbon</h4>
       <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div><label for="filterCustomer" class="block text-sm font-medium text-gray-700 mb-1">Pelanggan</label> <select id="filterCustomer" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="applyKasbonFilters()"> <option value="">Semua Pelanggan</option> </select>
        </div>
        <div><label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label> <select id="filterStatus" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="applyKasbonFilters()"> <option value="">Semua Status</option> <option value="lunas">Lunas</option> <option value="sebagian">Sebagian</option> <option value="belum">Belum Lunas</option> </select>
        </div>
        <div><label for="filterStartDate" class="block text-sm font-medium text-gray-700 mb-1">Dari Tanggal</label> <input type="date" id="filterStartDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="applyKasbonFilters()">
        </div>
        <div><label for="filterEndDate" class="block text-sm font-medium text-gray-700 mb-1">Sampai Tanggal</label> <input type="date" id="filterEndDate" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="applyKasbonFilters()">
        </div>
       </div>
       <div class="mt-3 flex gap-2"><button onclick="resetKasbonFilters()" class="btn text-sm" style="background-color: #6b7280; color: white; padding: 8px 16px;"> üîÑ Reset Filter </button>
        <div class="flex-1"></div><span id="filterResultCount" class="text-sm font-semibold self-center" style="color: #667eea;"></span>
       </div>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full" id="kasbonHistoryTable">
        <thead>
         <tr style="background-color: #667eea; color: white;">
          <th class="p-3 text-left rounded-tl-lg">Tanggal</th>
          <th class="p-3 text-left">Pelanggan</th>
          <th class="p-3 text-left">Jumlah</th>
          <th class="p-3 text-left">Terbayar</th>
          <th class="p-3 text-left">Keterangan</th>
          <th class="p-3 text-left rounded-tr-lg">Status</th>
         </tr>
        </thead>
        <tbody id="kasbonHistory">
        </tbody>
       </table>
      </div>
     </div>
    </div><!-- Payment Tab -->
    <div id="paymentTab" class="tab-content hidden">
     <div class="card mb-6">
      <div class="flex justify-between items-center mb-4">
       <h3 class="text-2xl font-bold" style="color: #667eea;">Tambah Pembayaran</h3>
      </div>
      <form id="paymentForm" class="space-y-4">
       <div><label for="paymentCustomer" class="block text-sm font-medium text-gray-700 mb-1">Pilih Pelanggan</label> <select id="paymentCustomer" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" onchange="updatePaymentInfo()"> <option value="">-- Pilih Pelanggan --</option> </select>
       </div>
       <div id="customerDebtInfo" class="hidden p-4 rounded-lg" style="background-color: #fef3c7;">
        <p class="font-semibold text-gray-700">Sisa Kasbon: <span id="customerDebtAmount" class="text-xl" style="color: #f59e0b;">Rp 0</span></p>
       </div><!-- Riwayat Kasbon Pelanggan dengan Checkbox -->
       <div id="customerKasbonHistory" class="hidden">
        <h4 class="text-lg font-semibold mb-3" style="color: #667eea;">üìã Pilih Transaksi Kasbon yang Akan Dibayar</h4>
        <div id="customerKasbonList" class="space-y-2 max-h-80 overflow-y-auto p-3 rounded-lg" style="background-color: #f9fafb; border: 1px solid #e5e7eb;">
        </div>
        <div class="mt-3 p-3 rounded-lg" style="background-color: #dbeafe;">
         <p class="text-sm font-semibold text-gray-700">Total Dipilih: <span id="selectedTotal" class="text-lg" style="color: #3b82f6;">Rp 0</span></p>
        </div>
       </div>
       <div><label for="paymentAmount" class="block text-sm font-medium text-gray-700 mb-1">Jumlah Pembayaran (Rp)</label> <input type="number" id="paymentAmount" required min="1" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan jumlah pembayaran">
        <p class="text-xs text-gray-500 mt-1">üí° Pilih transaksi kasbon di atas, lalu masukkan jumlah pembayaran</p>
       </div>
       <div class="flex gap-2"><button type="button" onclick="selectAllUnpaidKasbon()" class="btn flex-1" style="background-color: #10b981; color: white;"> ‚úì Pilih Belum Lunas </button> <button type="button" onclick="clearAllKasbon()" class="btn flex-1" style="background-color: #6b7280; color: white;"> ‚úó Bersihkan </button>
       </div>
       <div><label for="paymentDescription" class="block text-sm font-medium text-gray-700 mb-1">Keterangan</label> <textarea id="paymentDescription" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Keterangan pembayaran (opsional)"></textarea>
       </div><button type="submit" class="btn w-full" style="background-color: #667eea; color: white;"> üí≥ Simpan Pembayaran </button>
      </form>
     </div>
     <div class="card">
      <h3 class="text-2xl font-bold mb-4" style="color: #667eea;">Riwayat Pembayaran</h3>
      <div id="paymentHistory" class="space-y-3"></div>
     </div>
    </div>
   </main>
  </div>
  <script>
    let allData = [];
    let currentCustomerDebt = 0;
    let isLoading = false;

    const defaultConfig = {
      app_title: "Kasbon Kantin Asbaja",
      kantin_name: "Kantin Asbaja",
      primary_color: "#667eea",
      secondary_color: "#764ba2",
      accent_color: "#f59e0b",
      success_color: "#10b981",
      background_color: "#f3f4f6"
    };

    const dataHandler = {
      onDataChanged(data) {
        allData = data;
        updateUI();
      }
    };

    async function initApp() {
      const initResult = await window.dataSdk.init(dataHandler);
      if (!initResult.isOk) {
        showToast('Gagal menginisialisasi aplikasi', 'error');
        return;
      }
    }

    function updateUI() {
      updateCustomersList();
      updateKasbonHistory();
      updatePaymentHistory();
      updateCustomerDropdowns();
    }

    function getKasbonPaidAmount(kasbonId) {
      const kasbon = allData.find(d => d.id === kasbonId && d.type === 'kasbon');
      if (!kasbon) return 0;
      return kasbon.paid_amount || 0;
    }

    function updateCustomersList() {
      const customers = allData.filter(d => d.type === 'customer')
        .sort((a, b) => a.customer_name.localeCompare(b.customer_name));

      const listDiv = document.getElementById('customersList');
      if (customers.length === 0) {
        listDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada pelanggan</p>';
      } else {
        listDiv.innerHTML = customers.map(c => {
          const customerKasbons = allData.filter(d => d.type === 'kasbon' && d.customer_id === c.id);
          const totalKasbon = customerKasbons.reduce((sum, k) => sum + k.amount, 0);
          const totalPaid = customerKasbons.reduce((sum, k) => sum + (k.paid_amount || 0), 0);
          const debt = totalKasbon - totalPaid;

          return `
            <div class="p-4 rounded-lg border border-gray-200 flex justify-between items-center">
              <div>
                <p class="font-semibold text-lg">${c.customer_name}</p>
                <p class="text-sm" style="color: ${debt > 0 ? '#f59e0b' : '#10b981'};">
                  Sisa Kasbon: ${formatCurrency(debt)}
                </p>
              </div>
              <div class="flex gap-2">
                <button onclick="editCustomer('${c.id}')" class="btn text-sm" style="background-color: #3b82f6; color: white; padding: 8px 16px;">
                  ‚úèÔ∏è Edit
                </button>
                <button onclick="deleteCustomer('${c.id}')" class="btn text-sm" style="background-color: #ef4444; color: white; padding: 8px 16px;">
                  üóëÔ∏è Hapus
                </button>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    function updateKasbonHistory() {
      applyKasbonFilters();
    }

    function applyKasbonFilters() {
      const filterCustomerId = document.getElementById('filterCustomer').value;
      const filterStatus = document.getElementById('filterStatus').value;
      const filterStartDate = document.getElementById('filterStartDate').value;
      const filterEndDate = document.getElementById('filterEndDate').value;

      let kasbons = allData.filter(d => d.type === 'kasbon')
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // Filter by customer
      if (filterCustomerId) {
        kasbons = kasbons.filter(k => k.customer_id === filterCustomerId);
      }

      // Filter by date range
      if (filterStartDate) {
        const startDate = new Date(filterStartDate);
        startDate.setHours(0, 0, 0, 0);
        kasbons = kasbons.filter(k => new Date(k.date) >= startDate);
      }
      if (filterEndDate) {
        const endDate = new Date(filterEndDate);
        endDate.setHours(23, 59, 59, 999);
        kasbons = kasbons.filter(k => new Date(k.date) <= endDate);
      }

      // Calculate status for each kasbon
      const kasbonsWithStatus = kasbons.map(k => {
        const paidAmount = k.paid_amount || 0;
        let kasbonStatus = 'belum';
        let kasbonStatusText = 'Belum Lunas';
        let statusColor = '#f59e0b';
        let statusBg = '#fef3c7';
        
        if (paidAmount >= k.amount) {
          kasbonStatus = 'lunas';
          kasbonStatusText = 'Lunas';
          statusColor = '#10b981';
          statusBg = '#d1fae5';
        } else if (paidAmount > 0) {
          kasbonStatus = 'sebagian';
          kasbonStatusText = 'Sebagian';
          statusColor = '#3b82f6';
          statusBg = '#dbeafe';
        }

        return {
          ...k,
          status: kasbonStatus,
          statusText: kasbonStatusText,
          statusColor: statusColor,
          statusBg: statusBg
        };
      });

      // Filter by status
      let filteredKasbons = kasbonsWithStatus;
      if (filterStatus) {
        filteredKasbons = kasbonsWithStatus.filter(k => k.status === filterStatus);
      }

      // Update result count
      const resultCount = document.getElementById('filterResultCount');
      if (filterCustomerId || filterStatus || filterStartDate || filterEndDate) {
        resultCount.textContent = `Menampilkan ${filteredKasbons.length} dari ${kasbons.length} transaksi`;
      } else {
        resultCount.textContent = `Total: ${filteredKasbons.length} transaksi`;
      }

      const historyDiv = document.getElementById('kasbonHistory');
      if (filteredKasbons.length === 0) {
        historyDiv.innerHTML = '<tr><td colspan="6" class="text-gray-500 text-center py-8">Tidak ada data yang sesuai dengan filter</td></tr>';
      } else {
        historyDiv.innerHTML = filteredKasbons.map((k, index) => {
          const rowBg = index % 2 === 0 ? '#f9fafb' : 'white';
          const paidAmount = k.paid_amount || 0;
          
          return `
            <tr style="background-color: ${rowBg}; border-bottom: 1px solid #e5e7eb;">
              <td class="p-3 text-sm">${formatDate(k.date)}</td>
              <td class="p-3 font-semibold">${k.customer_name}</td>
              <td class="p-3 font-bold" style="color: #f59e0b;">${formatCurrency(k.amount)}</td>
              <td class="p-3 font-semibold" style="color: #10b981;">${formatCurrency(paidAmount)}</td>
              <td class="p-3 text-sm text-gray-600">${k.description || '-'}</td>
              <td class="p-3">
                <span class="px-3 py-1 rounded-full text-xs font-semibold" style="background-color: ${k.statusBg}; color: ${k.statusColor};">
                  ${k.statusText}
                </span>
              </td>
            </tr>
          `;
        }).join('');
      }
    }

    function resetKasbonFilters() {
      document.getElementById('filterCustomer').value = '';
      document.getElementById('filterStatus').value = '';
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      applyKasbonFilters();
    }

    function updatePaymentHistory() {
      const payments = allData.filter(d => d.type === 'payment')
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      const historyDiv = document.getElementById('paymentHistory');
      if (payments.length === 0) {
        historyDiv.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada riwayat pembayaran</p>';
      } else {
        historyDiv.innerHTML = payments.map(p => `
          <div class="p-4 rounded-lg border border-gray-200">
            <div class="flex justify-between items-start mb-2">
              <div>
                <p class="font-semibold text-lg">${p.customer_name}</p>
                <p class="text-sm text-gray-600">${formatDate(p.date)}</p>
              </div>
              <p class="text-xl font-bold" style="color: #10b981;">- ${formatCurrency(p.amount)}</p>
            </div>
            ${p.description ? `<p class="text-sm text-gray-600">${p.description}</p>` : ''}
          </div>
        `).join('');
      }
    }

    function updateCustomerDropdowns() {
      const customers = allData.filter(d => d.type === 'customer')
        .sort((a, b) => a.customer_name.localeCompare(b.customer_name));

      const kasbonSelect = document.getElementById('kasbonCustomer');
      const paymentSelect = document.getElementById('paymentCustomer');
      const filterSelect = document.getElementById('filterCustomer');

      const options = customers.map(c => 
        `<option value="${c.id}">${c.customer_name}</option>`
      ).join('');

      kasbonSelect.innerHTML = '<option value="">-- Pilih Pelanggan --</option>' + options;
      paymentSelect.innerHTML = '<option value="">-- Pilih Pelanggan --</option>' + options;
      filterSelect.innerHTML = '<option value="">Semua Pelanggan</option>' + options;
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.querySelectorAll('[id^="tab"]').forEach(btn => {
        btn.style.backgroundColor = '#e5e7eb';
        btn.style.color = '#374151';
      });

      document.getElementById(`${tabName}Tab`).classList.remove('hidden');
      const activeBtn = document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`);
      activeBtn.style.backgroundColor = '#667eea';
      activeBtn.style.color = 'white';

      if (tabName === 'kasbon') {
        const kasbonDateInput = document.getElementById('kasbonDate');
        if (kasbonDateInput && !kasbonDateInput.value) {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          kasbonDateInput.value = `${year}-${month}-${day}`;
        }
      }
    }

    function showAddCustomerModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h3 class="text-2xl font-bold mb-4" style="color: #667eea;">Tambah Pelanggan Baru</h3>
          <form id="addCustomerForm" class="space-y-4">
            <div>
              <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Nama Pelanggan</label>
              <input type="text" id="customerName" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Masukkan nama pelanggan">
            </div>
            <div class="flex gap-2">
              <button type="button" class="btn flex-1 cancel-btn" style="background-color: #e5e7eb; color: #374151;">
                Batal
              </button>
              <button type="submit" class="btn flex-1" style="background-color: #667eea; color: white;">
                Simpan
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      modal.querySelector('.cancel-btn').addEventListener('click', closeModal);

      document.getElementById('addCustomerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading) return;

        const name = document.getElementById('customerName').value.trim();
        if (!name) return;

        if (allData.length >= 999) {
          showToast('Batas maksimum 999 data tercapai. Hapus beberapa data terlebih dahulu.', 'error');
          return;
        }

        isLoading = true;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Menyimpan...<span class="loading-spinner"></span>';

        const result = await window.dataSdk.create({
          id: generateId(),
          type: 'customer',
          customer_name: name,
          created_at: new Date().toISOString()
        });

        isLoading = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Simpan';

        if (result.isOk) {
          playSuccessSound();
          showToast('Pelanggan berhasil ditambahkan!', 'success');
          closeModal();
        } else {
          showToast('Gagal menambahkan pelanggan', 'error');
        }
      });
    }

    async function editCustomer(customerId) {
      const customer = allData.find(d => d.id === customerId);
      if (!customer) return;

      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h3 class="text-2xl font-bold mb-4" style="color: #667eea;">Edit Pelanggan</h3>
          <form id="editCustomerForm" class="space-y-4">
            <div>
              <label for="editCustomerName" class="block text-sm font-medium text-gray-700 mb-1">Nama Pelanggan</label>
              <input type="text" id="editCustomerName" required value="${customer.customer_name}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            </div>
            <div class="flex gap-2">
              <button type="button" onclick="closeModal()" class="btn flex-1" style="background-color: #e5e7eb; color: #374151;">
                Batal
              </button>
              <button type="submit" class="btn flex-1" style="background-color: #667eea; color: white;">
                Update
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);

      document.getElementById('editCustomerForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isLoading) return;

        const newName = document.getElementById('editCustomerName').value.trim();
        if (!newName) return;

        isLoading = true;
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Mengupdate...<span class="loading-spinner"></span>';

        const updatedCustomer = { ...customer, customer_name: newName };
        const result = await window.dataSdk.update(updatedCustomer);

        const kasbons = allData.filter(d => d.type === 'kasbon' && d.customer_id === customerId);
        for (const kasbon of kasbons) {
          await window.dataSdk.update({ ...kasbon, customer_name: newName });
        }

        const payments = allData.filter(d => d.type === 'payment' && d.customer_id === customerId);
        for (const payment of payments) {
          await window.dataSdk.update({ ...payment, customer_name: newName });
        }

        isLoading = false;
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Update';

        if (result.isOk) {
          playSuccessSound();
          showToast('Pelanggan berhasil diupdate!', 'success');
          closeModal();
        } else {
          showToast('Gagal mengupdate pelanggan', 'error');
        }
      });
    }

    async function deleteCustomer(customerId) {
      const customer = allData.find(d => d.id === customerId);
      if (!customer) return;

      const hasTransactions = allData.some(d => 
        (d.type === 'kasbon' || d.type === 'payment') && d.customer_id === customerId
      );

      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      modal.innerHTML = `
        <div class="modal-content">
          <h3 class="text-2xl font-bold mb-4" style="color: #ef4444;">Konfirmasi Hapus</h3>
          <p class="mb-4">Apakah Anda yakin ingin menghapus pelanggan <strong>${customer.customer_name}</strong>?</p>
          ${hasTransactions ? '<p class="mb-4 text-red-600 font-semibold">‚ö†Ô∏è Semua transaksi kasbon dan pembayaran pelanggan ini juga akan dihapus!</p>' : ''}
          <div class="flex gap-2">
            <button type="button" onclick="closeModal()" class="btn flex-1" style="background-color: #e5e7eb; color: #374151;">
              Batal
            </button>
            <button type="button" onclick="confirmDeleteCustomer('${customerId}')" class="btn flex-1" style="background-color: #ef4444; color: white;">
              Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteCustomer(customerId) {
      if (isLoading) return;

      isLoading = true;
      const modal = document.querySelector('.modal-backdrop');
      const deleteBtn = modal.querySelector('button[onclick*="confirmDeleteCustomer"]');
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = 'Menghapus...<span class="loading-spinner"></span>';

      const customer = allData.find(d => d.id === customerId);
      const result = await window.dataSdk.delete(customer);

      const relatedKasbons = allData.filter(d => d.type === 'kasbon' && d.customer_id === customerId);
      for (const kasbon of relatedKasbons) {
        await window.dataSdk.delete(kasbon);
      }

      const relatedPayments = allData.filter(d => d.type === 'payment' && d.customer_id === customerId);
      for (const payment of relatedPayments) {
        await window.dataSdk.delete(payment);
      }

      isLoading = false;

      if (result.isOk) {
        playSuccessSound();
        showToast('Pelanggan dan semua transaksinya berhasil dihapus!', 'success');
        closeModal();
      } else {
        showToast('Gagal menghapus pelanggan', 'error');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = 'Hapus';
      }
    }

    document.getElementById('kasbonForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isLoading) return;

      const customerId = document.getElementById('kasbonCustomer').value;
      const kasbonDate = document.getElementById('kasbonDate').value;
      const amount = parseFloat(document.getElementById('kasbonAmount').value);
      const description = document.getElementById('kasbonDescription').value.trim();

      if (!customerId || !kasbonDate || !amount || amount <= 0) return;

      if (allData.length >= 999) {
        showToast('Batas maksimum 999 data tercapai. Hapus beberapa data terlebih dahulu.', 'error');
        return;
      }

      const customer = allData.find(d => d.id === customerId);
      if (!customer) return;

      isLoading = true;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Menyimpan...<span class="loading-spinner"></span>';

      const selectedDate = new Date(kasbonDate);
      selectedDate.setHours(12, 0, 0, 0);

      const result = await window.dataSdk.create({
        id: generateId(),
        type: 'kasbon',
        customer_id: customerId,
        customer_name: customer.customer_name,
        amount: amount,
        paid_amount: 0,
        description: description,
        date: selectedDate.toISOString(),
        created_at: new Date().toISOString()
      });

      isLoading = false;
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'üí∞ Simpan Kasbon';

      if (result.isOk) {
        playSuccessSound();
        showToast('Kasbon berhasil ditambahkan!', 'success');
        e.target.reset();
      } else {
        showToast('Gagal menambahkan kasbon', 'error');
      }
    });

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isLoading) return;

      const customerId = document.getElementById('paymentCustomer').value;
      const amount = parseFloat(document.getElementById('paymentAmount').value);
      const description = document.getElementById('paymentDescription').value.trim();

      if (!customerId || !amount || amount <= 0) {
        showToast('Pilih pelanggan dan masukkan jumlah pembayaran!', 'error');
        return;
      }

      if (selectedKasbonIds.size === 0) {
        showToast('Pilih minimal satu transaksi kasbon untuk dibayar!', 'error');
        return;
      }

      // Validasi: total pembayaran tidak boleh melebihi sisa kasbon yang dipilih
      let totalUnpaidSelected = 0;
      selectedKasbonIds.forEach(id => {
        const kasbon = allData.find(d => d.id === id && d.type === 'kasbon');
        if (kasbon) {
          const paidAmount = kasbon.paid_amount || 0;
          const remaining = kasbon.amount - paidAmount;
          totalUnpaidSelected += remaining;
        }
      });

      if (amount > totalUnpaidSelected) {
        showToast(`Jumlah pembayaran (${formatCurrency(amount)}) melebihi sisa kasbon yang dipilih (${formatCurrency(totalUnpaidSelected)})!`, 'error');
        return;
      }

      if (allData.length >= 999) {
        showToast('Batas maksimum 999 data tercapai. Hapus beberapa data terlebih dahulu.', 'error');
        return;
      }

      const customer = allData.find(d => d.id === customerId);
      if (!customer) return;

      isLoading = true;
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Menyimpan...<span class="loading-spinner"></span>';

      // Distribusikan pembayaran ke kasbon yang dipilih
      let remainingPayment = amount;
      const selectedKasbons = Array.from(selectedKasbonIds).map(id => 
        allData.find(d => d.id === id && d.type === 'kasbon')
      ).filter(Boolean).sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

      for (const kasbon of selectedKasbons) {
        if (remainingPayment <= 0) break;
        
        const currentPaid = kasbon.paid_amount || 0;
        const remaining = kasbon.amount - currentPaid;
        const paymentForThis = Math.min(remaining, remainingPayment);
        
        if (paymentForThis > 0) {
          const updatedKasbon = {
            ...kasbon,
            paid_amount: currentPaid + paymentForThis
          };
          await window.dataSdk.update(updatedKasbon);
          remainingPayment -= paymentForThis;
        }
      }

      const selectedKasbonList = selectedKasbons.map(k => 
        `${formatDate(k.date)} - ${formatCurrency(k.amount)}`
      ).join(', ');

      const paymentDescription = description || `Pembayaran untuk: ${selectedKasbonList}`;

      const result = await window.dataSdk.create({
        id: generateId(),
        type: 'payment',
        customer_id: customerId,
        customer_name: customer.customer_name,
        amount: amount,
        description: paymentDescription,
        date: new Date().toISOString(),
        created_at: new Date().toISOString()
      });

      isLoading = false;
      submitBtn.disabled = false;
      submitBtn.innerHTML = 'üí≥ Simpan Pembayaran';

      if (result.isOk) {
        playSuccessSound();
        showToast('Pembayaran berhasil dicatat!', 'success');
        e.target.reset();
        document.getElementById('customerDebtInfo').classList.add('hidden');
        document.getElementById('customerKasbonHistory').classList.add('hidden');
        selectedKasbonIds.clear();
        currentCustomerDebt = 0;
      } else {
        showToast('Gagal mencatat pembayaran', 'error');
      }
    });

    let selectedKasbonIds = new Set();

    function updatePaymentInfo() {
      const customerId = document.getElementById('paymentCustomer').value;
      if (!customerId) {
        document.getElementById('customerDebtInfo').classList.add('hidden');
        document.getElementById('customerKasbonHistory').classList.add('hidden');
        currentCustomerDebt = 0;
        selectedKasbonIds.clear();
        document.getElementById('paymentAmount').value = '';
        return;
      }

      selectedKasbonIds.clear();
      document.getElementById('paymentAmount').value = '';

      const customerKasbons = allData.filter(d => d.type === 'kasbon' && d.customer_id === customerId)
        .sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
      
      const totalKasbon = customerKasbons.reduce((sum, k) => sum + k.amount, 0);
      const totalPaid = customerKasbons.reduce((sum, k) => sum + (k.paid_amount || 0), 0);
      const debt = totalKasbon - totalPaid;

      currentCustomerDebt = debt;
      document.getElementById('customerDebtAmount').textContent = formatCurrency(debt);
      document.getElementById('customerDebtInfo').classList.remove('hidden');

      const historyDiv = document.getElementById('customerKasbonList');
      if (customerKasbons.length === 0) {
        historyDiv.innerHTML = '<p class="text-gray-500 text-center py-3">Belum ada kasbon untuk pelanggan ini</p>';
        document.getElementById('customerKasbonHistory').classList.remove('hidden');
      } else {
        historyDiv.innerHTML = customerKasbons.map(k => {
          const paidAmount = k.paid_amount || 0;
          const remaining = k.amount - paidAmount;
          const isFullyPaid = paidAmount >= k.amount;
          
          let statusBadge = '';
          if (isFullyPaid) {
            statusBadge = '<span class="px-2 py-1 rounded text-xs font-semibold ml-2" style="background-color: #d1fae5; color: #10b981;">‚úì Lunas</span>';
          } else if (paidAmount > 0) {
            statusBadge = '<span class="px-2 py-1 rounded text-xs font-semibold ml-2" style="background-color: #dbeafe; color: #3b82f6;">Sebagian</span>';
          }
          
          return `
            <div class="p-3 rounded-lg flex items-start gap-3" style="background-color: white; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s;" onclick="toggleKasbonSelection('${k.id}')" id="kasbon-${k.id}">
              <input type="checkbox" id="check-${k.id}" class="mt-1 w-5 h-5 cursor-pointer" style="accent-color: #667eea;" onchange="toggleKasbonSelection('${k.id}')">
              <div class="flex-1">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="text-sm text-gray-600">${formatDate(k.date)}${statusBadge}</p>
                    ${k.description ? `<p class="text-sm text-gray-700 mt-1">${k.description}</p>` : ''}
                    <p class="text-xs text-gray-500 mt-1">Terbayar: ${formatCurrency(paidAmount)} / ${formatCurrency(k.amount)}</p>
                    ${!isFullyPaid ? `<p class="text-xs font-semibold mt-1" style="color: #f59e0b;">Sisa: ${formatCurrency(remaining)}</p>` : ''}
                  </div>
                  <p class="font-bold" style="color: #f59e0b;">${formatCurrency(k.amount)}</p>
                </div>
              </div>
            </div>
          `;
        }).join('');
        document.getElementById('customerKasbonHistory').classList.remove('hidden');
      }
      updateSelectedTotal();
    }

    function toggleKasbonSelection(kasbonId) {
      if (selectedKasbonIds.has(kasbonId)) {
        selectedKasbonIds.delete(kasbonId);
      } else {
        selectedKasbonIds.add(kasbonId);
      }
      updateSelectedTotal();
      updateKasbonVisuals();
    }

    function updateKasbonVisuals() {
      selectedKasbonIds.forEach(id => {
        const element = document.getElementById(`kasbon-${id}`);
        const checkbox = document.getElementById(`check-${id}`);
        if (element) {
          element.style.borderColor = '#667eea';
          element.style.backgroundColor = '#ede9fe';
        }
        if (checkbox) {
          checkbox.checked = true;
        }
      });

      const customerId = document.getElementById('paymentCustomer').value;
      const customerKasbons = allData.filter(d => d.type === 'kasbon' && d.customer_id === customerId);
      
      customerKasbons.forEach(k => {
        if (!selectedKasbonIds.has(k.id)) {
          const element = document.getElementById(`kasbon-${k.id}`);
          const checkbox = document.getElementById(`check-${k.id}`);
          if (element) {
            element.style.borderColor = '#e5e7eb';
            element.style.backgroundColor = 'white';
          }
          if (checkbox) {
            checkbox.checked = false;
          }
        }
      });
    }

    function updateSelectedTotal() {
      let total = 0;
      selectedKasbonIds.forEach(id => {
        const kasbon = allData.find(d => d.id === id && d.type === 'kasbon');
        if (kasbon) {
          const paidAmount = kasbon.paid_amount || 0;
          const remaining = kasbon.amount - paidAmount;
          total += remaining;
        }
      });
      
      document.getElementById('selectedTotal').textContent = formatCurrency(total);
    }

    function selectAllUnpaidKasbon() {
      const customerId = document.getElementById('paymentCustomer').value;
      if (!customerId) return;

      const customerKasbons = allData.filter(d => d.type === 'kasbon' && d.customer_id === customerId);
      selectedKasbonIds.clear();
      
      // Hanya pilih kasbon yang belum lunas
      customerKasbons.forEach(k => {
        const paidAmount = k.paid_amount || 0;
        if (paidAmount < k.amount) {
          selectedKasbonIds.add(k.id);
        }
      });
      
      updateSelectedTotal();
      updateKasbonVisuals();
    }

    function clearAllKasbon() {
      selectedKasbonIds.clear();
      updateSelectedTotal();
      updateKasbonVisuals();
    }

    function closeModal() {
      const modal = document.querySelector('.modal-backdrop');
      if (modal) {
        modal.remove();
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function playSuccessSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.2);
    }

    function formatCurrency(amount) {
      return 'Rp ' + amount.toLocaleString('id-ID');
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('id-ID', { 
        day: '2-digit', 
        month: 'short', 
        year: 'numeric'
      });
    }

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function printKasbonPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape', 'mm', 'a4');
      
      // Get filtered data
      const filterCustomerId = document.getElementById('filterCustomer').value;
      const filterStatus = document.getElementById('filterStatus').value;
      const filterStartDate = document.getElementById('filterStartDate').value;
      const filterEndDate = document.getElementById('filterEndDate').value;

      let kasbons = allData.filter(d => d.type === 'kasbon')
        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

      // Apply filters
      if (filterCustomerId) {
        kasbons = kasbons.filter(k => k.customer_id === filterCustomerId);
      }
      if (filterStartDate) {
        const startDate = new Date(filterStartDate);
        startDate.setHours(0, 0, 0, 0);
        kasbons = kasbons.filter(k => new Date(k.date) >= startDate);
      }
      if (filterEndDate) {
        const endDate = new Date(filterEndDate);
        endDate.setHours(23, 59, 59, 999);
        kasbons = kasbons.filter(k => new Date(k.date) <= endDate);
      }

      // Calculate status
      const kasbonsWithStatus = kasbons.map(k => {
        const paidAmount = k.paid_amount || 0;
        let statusText = 'Belum Lunas';
        
        if (paidAmount >= k.amount) {
          statusText = 'Lunas';
        } else if (paidAmount > 0) {
          statusText = 'Sebagian';
        }

        return { ...k, statusText };
      });

      // Filter by status
      let filteredKasbons = kasbonsWithStatus;
      if (filterStatus) {
        filteredKasbons = kasbonsWithStatus.filter(k => {
          if (filterStatus === 'lunas') return k.statusText === 'Lunas';
          if (filterStatus === 'sebagian') return k.statusText === 'Sebagian';
          if (filterStatus === 'belum') return k.statusText === 'Belum Lunas';
          return true;
        });
      }

      // Get config values
      const appTitle = (window.elementSdk && window.elementSdk.config) ? 
        (window.elementSdk.config.app_title || defaultConfig.app_title) : 
        defaultConfig.app_title;
      const kantinName = (window.elementSdk && window.elementSdk.config) ? 
        (window.elementSdk.config.kantin_name || defaultConfig.kantin_name) : 
        defaultConfig.kantin_name;

      // Header
      doc.setFontSize(18);
      doc.setFont(undefined, 'bold');
      doc.text(appTitle, 148, 15, { align: 'center' });
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'normal');
      doc.text(kantinName, 148, 22, { align: 'center' });
      
      doc.setFontSize(14);
      doc.setFont(undefined, 'bold');
      doc.text('LAPORAN RIWAYAT KASBON', 148, 32, { align: 'center' });
      
      // Print date and filter info
      doc.setFontSize(9);
      doc.setFont(undefined, 'normal');
      const printDate = new Date().toLocaleDateString('id-ID', { 
        day: '2-digit', 
        month: 'long', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      doc.text(`Dicetak: ${printDate}`, 15, 40);
      
      let filterInfo = [];
      if (filterCustomerId) {
        const customer = allData.find(d => d.id === filterCustomerId);
        if (customer) filterInfo.push(`Pelanggan: ${customer.customer_name}`);
      }
      if (filterStatus) {
        const statusMap = { 'lunas': 'Lunas', 'sebagian': 'Sebagian', 'belum': 'Belum Lunas' };
        filterInfo.push(`Status: ${statusMap[filterStatus]}`);
      }
      if (filterStartDate || filterEndDate) {
        const start = filterStartDate ? new Date(filterStartDate).toLocaleDateString('id-ID') : '-';
        const end = filterEndDate ? new Date(filterEndDate).toLocaleDateString('id-ID') : '-';
        filterInfo.push(`Periode: ${start} s/d ${end}`);
      }
      
      if (filterInfo.length > 0) {
        doc.text(`Filter: ${filterInfo.join(' | ')}`, 15, 45);
      }

      // Table data
      const tableData = filteredKasbons.map(k => {
        const paidAmount = k.paid_amount || 0;
        return [
          formatDate(k.date),
          k.customer_name,
          formatCurrency(k.amount),
          formatCurrency(paidAmount),
          formatCurrency(k.amount - paidAmount),
          k.description || '-',
          k.statusText
        ];
      });

      // Calculate totals
      const totalKasbon = filteredKasbons.reduce((sum, k) => sum + k.amount, 0);
      const totalPaid = filteredKasbons.reduce((sum, k) => sum + (k.paid_amount || 0), 0);
      const totalRemaining = totalKasbon - totalPaid;

      // Add table
      doc.autoTable({
        startY: filterInfo.length > 0 ? 50 : 45,
        head: [['Tanggal', 'Pelanggan', 'Jumlah Kasbon', 'Terbayar', 'Sisa', 'Keterangan', 'Status']],
        body: tableData,
        foot: [[
          { content: 'TOTAL', colSpan: 2, styles: { halign: 'center', fontStyle: 'bold' } },
          { content: formatCurrency(totalKasbon), styles: { fontStyle: 'bold' } },
          { content: formatCurrency(totalPaid), styles: { fontStyle: 'bold' } },
          { content: formatCurrency(totalRemaining), styles: { fontStyle: 'bold' } },
          { content: '', colSpan: 2 }
        ]],
        theme: 'grid',
        styles: {
          fontSize: 9,
          cellPadding: 3,
          overflow: 'linebreak',
          halign: 'left'
        },
        headStyles: {
          fillColor: [102, 126, 234],
          textColor: 255,
          fontStyle: 'bold',
          halign: 'center'
        },
        footStyles: {
          fillColor: [240, 240, 240],
          textColor: 0,
          fontStyle: 'bold'
        },
        columnStyles: {
          0: { cellWidth: 30 },
          1: { cellWidth: 40 },
          2: { cellWidth: 35, halign: 'right' },
          3: { cellWidth: 35, halign: 'right' },
          4: { cellWidth: 35, halign: 'right' },
          5: { cellWidth: 50 },
          6: { cellWidth: 25, halign: 'center' }
        },
        didParseCell: function(data) {
          if (data.section === 'body' && data.column.index === 6) {
            const status = data.cell.raw;
            if (status === 'Lunas') {
              data.cell.styles.textColor = [16, 185, 129];
              data.cell.styles.fontStyle = 'bold';
            } else if (status === 'Sebagian') {
              data.cell.styles.textColor = [59, 130, 246];
              data.cell.styles.fontStyle = 'bold';
            } else {
              data.cell.styles.textColor = [245, 158, 11];
              data.cell.styles.fontStyle = 'bold';
            }
          }
        }
      });

      // Footer
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setFont(undefined, 'normal');
        doc.text(`Halaman ${i} dari ${pageCount}`, 148, 200, { align: 'center' });
      }

      // Save PDF
      const fileName = `Laporan_Kasbon_${new Date().getTime()}.pdf`;
      doc.save(fileName);
      
      showToast('PDF berhasil dibuat!', 'success');
    }

    async function onConfigChange(config) {
      const appTitle = config.app_title || defaultConfig.app_title;
      const kantinName = config.kantin_name || defaultConfig.kantin_name;

      document.getElementById('appTitle').textContent = appTitle;
      document.getElementById('kantinName').textContent = kantinName;
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig: defaultConfig,
        onConfigChange: onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.primary_color || defaultConfig.primary_color,
              set: (value) => {
                config.primary_color = value;
                window.elementSdk.setConfig({ primary_color: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["kantin_name", config.kantin_name || defaultConfig.kantin_name]
        ])
      });
    }

    initApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99dab67463bafd9e',t:'MTc2Mjk5OTYxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
